{"version":3,"names":["ActivityIndicator","FlatList","View","BottomSheet","BottomSheetConsumer","debounce","useState","useEffect","useRef","useSelect","styles","PER_PAGE","REQUEST_DEBOUNCE_DELAY","MINIMUM_QUERY_SIZE","meetsThreshold","query","length","LinkPickerResults","onLinkPicked","directEntry","links","setLinks","hasAllSuggestions","setHasAllSuggestions","nextPage","pendingRequest","clearRequest","current","fetchMoreSuggestions","select","getSettings","fetchLinkSuggestions","search","__experimentalFetchLinkSuggestions","page","type","perPage","fetchMore","currentSuggestions","request","suggestions","onEndReached","spinner","createElement","style","testID","animating","listProps","data","keyboardShouldPersistTaps","renderItem","item","LinkSuggestionItemCell","suggestion","keyExtractor","url","onEndReachedThreshold","initialNumToRender","ListFooterComponent","contentContainerStyle","list"],"sources":["@wordpress/components/src/mobile/link-picker/link-picker-results.native.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { ActivityIndicator, FlatList, View } from 'react-native';\n\n/**\n * WordPress dependencies\n */\nimport { BottomSheet, BottomSheetConsumer } from '@wordpress/components';\nimport { debounce } from '@wordpress/compose';\nimport { useState, useEffect, useRef } from '@wordpress/element';\nimport { useSelect } from '@wordpress/data';\n\n/**\n * Internal dependencies\n */\nimport styles from './styles.scss';\n\nconst PER_PAGE = 20;\nconst REQUEST_DEBOUNCE_DELAY = 400;\nconst MINIMUM_QUERY_SIZE = 2;\nconst meetsThreshold = ( query ) => MINIMUM_QUERY_SIZE <= query.length;\n\nexport default function LinkPickerResults( {\n\tquery,\n\tonLinkPicked,\n\tdirectEntry,\n} ) {\n\tconst [ links, setLinks ] = useState( [ directEntry ] );\n\tconst [ hasAllSuggestions, setHasAllSuggestions ] = useState( false );\n\tconst nextPage = useRef( 1 );\n\tconst pendingRequest = useRef();\n\tconst clearRequest = () => {\n\t\tpendingRequest.current = null;\n\t};\n\n\t// A stable debounced function to fetch suggestions and append.\n\tconst { fetchMoreSuggestions } = useSelect( ( select ) => {\n\t\tconst { getSettings } = select( 'core/block-editor' );\n\t\tconst fetchLinkSuggestions = async ( { search } ) => {\n\t\t\tif ( meetsThreshold( search ) ) {\n\t\t\t\treturn await getSettings().__experimentalFetchLinkSuggestions(\n\t\t\t\t\tsearch,\n\t\t\t\t\t{ page: nextPage.current, type: 'post', perPage: PER_PAGE }\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t\tconst fetchMore = async ( {\n\t\t\tquery: search,\n\t\t\tlinks: currentSuggestions,\n\t\t} ) => {\n\t\t\t// Return early if we've already detected the end of data or we are\n\t\t\t// already awaiting a response.\n\t\t\tif ( hasAllSuggestions || pendingRequest.current ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst request = fetchLinkSuggestions( { search } );\n\t\t\tpendingRequest.current = request;\n\t\t\tconst suggestions = await request;\n\n\t\t\t// Only update links for the most recent request.\n\t\t\tif ( suggestions && request === pendingRequest.current ) {\n\t\t\t\t// Since we don't have the response header, we check if the results\n\t\t\t\t// are truncated to determine we've reached the end.\n\t\t\t\tif ( suggestions.length < PER_PAGE ) {\n\t\t\t\t\tsetHasAllSuggestions( true );\n\t\t\t\t}\n\t\t\t\tsetLinks( [ ...currentSuggestions, ...suggestions ] );\n\t\t\t\tnextPage.current++;\n\t\t\t}\n\n\t\t\tclearRequest();\n\t\t};\n\t\treturn {\n\t\t\tfetchMoreSuggestions: debounce( fetchMore, REQUEST_DEBOUNCE_DELAY ),\n\t\t};\n\t\t// Disable eslint rule for now, to avoid introducing a regression\n\t\t// (see https://github.com/WordPress/gutenberg/pull/23922#discussion_r1170634879).\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\n\t}, [] );\n\n\t// Prevent setting state when unmounted.\n\tuseEffect( () => clearRequest, [] );\n\n\t// Any time the query changes, we reset pagination.\n\tuseEffect( () => {\n\t\tclearRequest();\n\t\tnextPage.current = 1;\n\t\tsetHasAllSuggestions( false );\n\t\tsetLinks( [ directEntry ] );\n\t\tfetchMoreSuggestions( { query, links: [ directEntry ] } );\n\t\t// Disable reason: deferring this refactor to the native team.\n\t\t// see https://github.com/WordPress/gutenberg/pull/41166\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\n\t}, [ query ] );\n\n\tconst onEndReached = () => fetchMoreSuggestions( { query, links } );\n\n\tconst spinner = ! hasAllSuggestions && meetsThreshold( query ) && (\n\t\t<View style={ styles.spinner } testID=\"link-picker-loading\">\n\t\t\t<ActivityIndicator animating />\n\t\t</View>\n\t);\n\n\treturn (\n\t\t<BottomSheetConsumer>\n\t\t\t{ ( { listProps } ) => (\n\t\t\t\t<FlatList\n\t\t\t\t\tdata={ links }\n\t\t\t\t\tkeyboardShouldPersistTaps=\"always\"\n\t\t\t\t\trenderItem={ ( { item } ) => (\n\t\t\t\t\t\t<BottomSheet.LinkSuggestionItemCell\n\t\t\t\t\t\t\tsuggestion={ item }\n\t\t\t\t\t\t\tonLinkPicked={ onLinkPicked }\n\t\t\t\t\t\t/>\n\t\t\t\t\t) }\n\t\t\t\t\tkeyExtractor={ ( { url, type } ) => `${ url }-${ type }` }\n\t\t\t\t\tonEndReached={ onEndReached }\n\t\t\t\t\tonEndReachedThreshold={ 0.1 }\n\t\t\t\t\tinitialNumToRender={ PER_PAGE }\n\t\t\t\t\tListFooterComponent={ spinner }\n\t\t\t\t\t{ ...listProps }\n\t\t\t\t\tcontentContainerStyle={ [\n\t\t\t\t\t\t...listProps.contentContainerStyle,\n\t\t\t\t\t\tstyles.list,\n\t\t\t\t\t] }\n\t\t\t\t/>\n\t\t\t) }\n\t\t</BottomSheetConsumer>\n\t);\n}\n"],"mappings":"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"}